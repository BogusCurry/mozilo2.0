<?php if(!defined('IS_CMS')) die();

class SEARCH extends Plugin {

# möglichkeiten für  in plugin_first:
#   define("CAT_REQUEST",NULL); und define("PAGE_REQUEST",NULL); = es gibt kein activen menu punkt
#   define("ACTION_REQUEST","search"); = default websittitel und detailmenu (mit den suchergebnissen)
#           wenn die CAT_REQUEST und PAGE_REQUEST noch nicht definiert worden sind werden die durch
#           ACTION_REQUEST=search gesetzt
#   eigener {WEBSITE_TITLE} die einfach erseten
#   eigenes {DETAILMENU} die einfach erseten
    function getContent($value) {

$serachhelp = "Hilfe";
$serachhelptext = 'Für die Suche müssen sie Suchbegriffe in folgender Syntax eingeben.<br />Durch Lehrzeichen getrente Begriffe ist eine oder Suche.<br />Begriffen die ein Lehrzeichen enthalten müssen mit " oder \' umschlossen werden.';
$serachtitle = "Suche in Website";
$serachlinktitle = "Suchen";
$resulttitlefind = "Gefundene Seiten";
$resulttitlenofind = "Es konte nichts gefunden werden";
$resulttitlenowords = "Keine suchbegriffe eingegeben";
$resultnofind = "{SEARCH_HELP_TEXT}";
$resultnowords = "{SEARCH_HELP_TEXT}";
$tmpl_fild = '{SEARCH_TITLE}
{SEARCH_FILD}';
$tmpl_result = '{RESULT_TITLE}
{RESULT}';
# {SEARCH_HELP_LINK} {SEARCH_HELP_TEXT}
#{SEARCHFILD} {SEARCHOUT} {SEARCHWORDS}
#$help = '<a href="'.$CatPage->get_Href($cat,$page,$CatPage->get_Query("helpsearch=true")).'">Hilfe</a>';
$tmpl_search = array("{SEARCH_TITLE}","{SEARCH_FILD}","{RESULT}","{RESULT_TITLE}","{SEARCH_HELP_LINK}","{SEARCH_HELP_TEXT}");
#$tmpl_replace = array($search_title,$serach_fild,$result,$result_title,$serach_help_link,$search_help_text);
$search_title = $serachtitle; $serach_fild = "";
$result = ""; $result_title = "";
$serach_help_link = "hilfe link"; $search_help_text = $serachhelptext;

        global $CMS_CONF;
        global $language;
        $search_form_in = array();
        $search_cat = $language->getLanguageValue("message_search_0");
        if(strlen($this->settings->get("searchcat")) > 0) {
            $search_cat = $this->settings->get("searchcat");
        }
        $search_url = URL_BASE."index.php?cat=".$search_cat;
        $search_form_in = array("cat" => $search_cat);
        if($CMS_CONF->get("modrewrite") == "true") {
            $search_url = URL_BASE.$search_cat.".html";
            $search_form_in = array();
        }
/*
message_search_0         = Suchen
message_searchresult_1   = Suchergebnisse für "{PARAM1}"
message_searchnoresult_1 = Es konnte mit diesen Suchbegriffen "{PARAM1}" kein Inhalt gefunden werden
message_searchhelp_0     = Für die Suche müssen sie Suchbegriffe in folgender Syntax eingeben. Durch Lehrzeichen getrente Begriffe ist eine oder Suche, Begriffen die ein Lehrzeichen enthalten mit " oder ' klammern.
*/
        if($value === false and $this->settings->get("searchart") == "searchlink") {
            global $specialchars;
            return '<a href="'.$search_url.'" class="searchlink" title="'.$specialchars->rebuildSpecialChars($search_cat,false,true).'">'.$search_cat.'</a>';
        }
/*        if(strstr($value,"searchlink=")) {
            global $CatPage;
            list($cat,$page) = $CatPage->split_CatPage_fromSyntax(str_replace("searchlink=","",$value));
            return $CatPage->create_AutoLinkTag($cat,$page,"searchlink");
        }
*/
        require_once(BASE_DIR_CMS."SearchClass.php");
        $search = new SearchClass("SEARCH");

        # Die Suche oder Ausgabe ist in einer Virtuellen Inhaltseite
        if($value == "plugin_first" and $this->settings->get("searchart") != "page") {
/*            if($this->settings->get("searchtemplate"))
                $tmpl = $this->settings->get("searchtemplate");
            else
                $tmpl = "{SEARCHFILD} {SEARCHOUT} {SEARCHWORDS}";
*/
#            global $syntax;
#$tmpl = $syntax->preparePageContent($tmpl);
            # für die Detailmenu ausgabe denn link setzen
            global $CatPage;
            $CatPage->ActionLinksearch = $search_url;
            # für Detailmenu und websitetitel denn ausgabe Text überschreiben
            if(strlen($this->settings->get("detailmenutext")) > 0) {
                $language->LANG_CONF->set("message_searchresult_1",$this->settings->get("detailmenutext"));
            }
            # wir suchen was oder haben auf einen such link geklickt
            if(strstr($_SERVER['REQUEST_URI'],$search_url)) {
                global $template,$pagecontent;
#                define("CAT_REQUEST",NULL);
#                define("PAGE_REQUEST",NULL);
                define("ACTION_CONTENT",false);
                define("ACTION_REQUEST","search");
                $fild = "";
                $out = "";
                $searchwords = "";
global $specialchars;
global $SEARCH_REQUEST;
$searchwords = $specialchars->rebuildSpecialChars($SEARCH_REQUEST, false, false);
#echo "drin searchlink";
$tmpl = "";
                # wir haben searchfeld im template
                if($this->settings->get("searchart") == "search") {
                    $tmpl = $tmpl_result;
                    if(getRequestValue('search') != "") {
                        $findpages = $search->getFindPageArray();
                        if(count($findpages) < 1) {
                            $result = $resultnofind;
                            $result_title = $resulttitlenofind;
                        } else {
                            $result = $search->getFindPagesMenuList($findpages);
                            $result_title = $resulttitlefind;
                        }
#                        $result = $search->searchInPages();
                    } else {
                        $result = $resultnowords;
                        $result_title = $resulttitlenowords;
                    }
#                    $pagecontent = "{SEARCH|out}";
#echo "drin searchlink";
#                    $pagecontent = str_replace(array("{SEARCHOUT}","{SEARCHWORDS}"),array($out,$searchwords),$tmpl);
                # wir haben nur einen such link ohne cat
                } elseif($this->settings->get("searchart") == "searchlink") {
                    $tmpl = $tmpl_fild.$tmpl_result; 
                    $serach_fild =  $search->getUserSearchForm("search",$search_url,"default",$search_form_in);
                    if(getRequestValue('search') !== false) {
                        if(getRequestValue('search') != "") {
                            $findpages = $search->getFindPageArray();
                            if(count($findpages) < 1) {
                                $result = $resultnofind;
                                $result_title = $resulttitlenofind;
                            } else {
                                $result = $search->getFindPagesMenuList($findpages);
                                $result_title = $resulttitlefind;
                            }
#                            $result = $search->searchInPages();
                        } else {
                            $result = $resultnowords;
                            $result_title = $resulttitlenowords;
                        }
                    }

#                    $pagecontent = str_replace(array("{SEARCHFILD}","{SEARCHOUT}","{SEARCHWORDS}"),array($fild,$out,$searchwords),$tmpl);
                }

#$tmpl_replace = array($search_title,$serach_fild,$result,$result_title,$serach_help_link,$search_help_text);
#$pagecontent = str_replace($tmpl_search,$tmpl_replace,$tmpl);
$pagecontent = "{SEARCH|virtuel}";
#$pagecontent = $this->getSearchContent($tmpl,$search_title,$serach_fild,$result,$result_title,$serach_help_link,$search_help_text);
            }
            return false;
        }
if($value == "virtuel") {
}
        # Suchfeld ausgabe
        if($value === false) {
            # Such sachen sind in einer Inhaltseite
            if($this->settings->get("searchart") == "page") {
                global $CatPage;
                $search_url = $CatPage->get_Href(CAT_REQUEST,PAGE_REQUEST);
                $search_form_in = array();
                if($CMS_CONF->get("modrewrite") != "true") {
                    $search_form_in = array("cat" => CAT_REQUEST,"page" => PAGE_REQUEST);
                }
            }
            return $search->getUserSearchForm("search",$search_url,"default",$search_form_in);
        }
        # Suchergebnisse
        if($value == "out") {
            if(getRequestValue('search') === false) return NULL;
            if(getRequestValue('search') != "") {
                return "<br />".$search->searchInPages();
            } else {
                return "<br />"."keine para";
            }
        }

        return NULL;
    } // function getContent

    function getSearchContent($tmpl,$search_title,$serach_fild,$result,$result_title,$serach_help_link,$search_help_text) {
#        $tmpl_search = array(,,,,,);
$tmpl = str_replace("{SEARCH_TITLE}",$search_title,$tmpl);
$tmpl = str_replace("{SEARCH_FILD}",$serach_fild,$tmpl);
$tmpl = str_replace("{RESULT}",$result,$tmpl);
$tmpl = str_replace("{RESULT_TITLE}",$result_title,$tmpl);
$tmpl = str_replace("{SEARCH_HELP_LINK}",$serach_help_link,$tmpl);
$tmpl = str_replace("{SEARCH_HELP_TEXT}",$search_help_text,$tmpl);
return $tmpl;
    }

    function getConfig() {
        global $ADMIN_CONF;
        $language = $ADMIN_CONF->get("language");
        if(IS_ADMIN and $this->settings->get("plugin_first") !== "true") {
            $this->settings->set("plugin_first","true");
        }
/*return array();*/
/*        $config['deDE']['defaultsearch'] = array(
            "type" => "checkbox",
            "description" => "mozilo Standart Suchverhalten benutzen."
        );
        $config['deDE']['searchinpage'] = array(
            "type" => "checkbox",
            "description" => "Die Suche ist in einer Inhaltseite"
        );
*/
        global $CatPage;
        $descriptions = array("search" => "Suchfeld","searchlink" => "Suchlink");
        $cat_array = $CatPage->get_CatArray(false,false,array(EXT_PAGE,EXT_HIDDEN));
        foreach($CatPage->get_CatArray(false,false,array(EXT_PAGE,EXT_HIDDEN)) as $cat) {
            $descriptions[FILE_START.$cat.FILE_END] = "<b>".$CatPage->get_HrefText($cat, false)."</b>";
            foreach($CatPage->get_PageArray($cat, array(EXT_PAGE,EXT_HIDDEN), true) as $page) {
                $descriptions[FILE_START.$cat.":".$page.FILE_END] = "&nbsp;&nbsp;&nbsp;&nbsp;&bull;&nbsp;".$CatPage->get_HrefText($cat, $page);
            }
        }
        $config['deDE']['menu_2'] = array(
            "type" => "select",
            "description" => "Kategorie wählen für Menu_2",
            "descriptions" => $descriptions,
            "multiple" => "false"
            ); 



        $config['deDE']['searchart'] = array(
            "type" => "radio",
            "description" => "Art der Ausgabe:<br />&nbsp;&nbsp;&nbsp;Ich benutze ein Suchfeld und die Ausgabe ist in einer Virtuelen Inhaltseite = Suchfeld<br />&nbsp;&nbsp;&nbsp;Ich benutze ein Suchlink und die Ausgabe ist in einer Virtuelen Inhaltseite = Suchlink<br />&nbsp;&nbsp;&nbsp;Ich habe eine normale Inhaltseite in der alles enthalten ist = Inhaltseite",
            "descriptions" => array(
                "search" => "Suchfeld",
                "searchlink" => "Suchlink",
                "page" => "Inhaltseite"
                )
        );
        $config['deDE']['detailmenutext']  = array(
            "type" => "text",
            "description" => "Text der anstelle des Detailmenu erscheinen soll. {PARAM1} wird mit den Suchbegriffen ersetzt",
            "maxlength" => "300",
        );
        $config['deDE']['searchcat']  = array(
            "type" => "text",
            "description" => 'Wie soll die Suchen Link heisen wenn lehr ist sie "Suchen"',
            "maxlength" => "100",
        );
        $config['deDE']['searchtemplate'] = array(
            "type" => "textarea",
#            "cols" => "90",
            "rows" => "7",
            "description" => "suchergebnis Template",
            "template" => "{searchtemplate_description}<br /><br />{searchtemplate_textarea}",
        );
/*        global $specialchars;
        global $CatPage;

        // Das mu� auf jeden Fall geschehen!
        $config['deDE'] = array();
        $descriptions = array("no_menu2" => "Kategorie wählen für Menu_2");
        $cat_array = $CatPage->get_CatArray(false,false,array(EXT_PAGE,EXT_HIDDEN));
        foreach($cat_array as $cat) {
            $descriptions[$cat] = $CatPage->get_HrefText($cat, false);
        }
        $config['deDE']['menu_2'] = array(
            "type" => "select",
            "description" => "Kategorie wählen für Menu_2",
            "descriptions" => $descriptions,
            "multiple" => "false"
            ); 
*/
        if(isset($config[$language])) {
            return $config[$language];
        } else {
            return $config['deDE'];
        }
    } // function getConfig    

    function getInfo() {
        global $ADMIN_CONF;
        $language = $ADMIN_CONF->get("language");

        $info['deDE'] = array(
            // Plugin-Name
            "<b>SEARCH</b> \$Revision: 137 $",
            // Plugin-Version
            "2.0",
            // Kurzbeschreibung
            'Erzeugt diese Menues:<br />
            Mainmenu <SPAN style="font-weight:bold;">{MENUES|main}</SPAN><br />
            DetailMenu <SPAN style="font-weight:bold;">{MENUES|detail}</SPAN> nur wenn "Normales Detailmenü" im admin Eingestelt ist<br />
            Menu_2 <SPAN style="font-weight:bold;">{MENUES|menu_2}</SPAN> Menu_2 ist eine Kategorie die Gewählt werden kann.<br />
            Sie wird im Mainmenu nicht angezeigt und es erscheinen nur die Inhaltseiten dieser Kategorie als Menu_2',
            // Name des Autors
            "stefanbe",
            // Download-URL
            "",
            array("{SEARCH}" => "Suchfeld",
                  "{SEARCH|searchlink}" => "Link zum Suchfeld",
#                  "{SEARCH|searchlink=cat:page}" => "Optionaler Link zur Inhaltseite mit der Suche",
                  "{SEARCH|out}" => "Such Ausgabe")
            );

        if(isset($info[$language])) {
            return $info[$language];
        } else {
            return $info['deDE'];
        }
    } // function getInfo



} // class DEMOPLUGIN
/*
#----------------------------------------------------
        # standart mozilo suche
        if($this->settings->get("defaultsearch") == "true") {
            if($value == "plugin_first")
                return false;
            require_once(BASE_DIR_CMS."SearchClass.php");
            $search = new SearchClass("SEARCH");
            return $search->getSearchForm();
        }


        require_once(BASE_DIR_CMS."SearchClass.php");
        $search = new SearchClass("SEARCH");

$search_page = false;
if(strstr($_SERVER['REQUEST_URI'],$search_cat))
    $search_page = true;

$ttt = false;

        if($value == "plugin_first" and $search_page) {
            define("CAT_REQUEST",NULL);
            define("PAGE_REQUEST",NULL);
$rr = "search";
#echo $CatPage->{ActionLink.$rr};
#$this->ActionLinksearch sitemap
#echo "drin";
if(strlen($this->settings->get("detailmenutext")) > 0) {
    global $language;
    $language->LANG_CONF->set("message_searchresult_1",$this->settings->get("detailmenutext"));
}
if($ttt) {
global $template;
global $syntax;
$title = $syntax->getWebsiteTitle("Suchen",false);
$template = str_replace("{WEBSITE_TITLE}",$title,$template);
#$template = str_replace("{DETAILMENU}","Suchen",$template);
} else
    define("ACTION_REQUEST","search");
            global $pagecontent;
            $pagecontent = $search->getUserSearchForm("search",$search_url,"default",$search_form_in);
        if(getRequestValue('search') !== false) {
            if(getRequestValue('search') != "") {
                $pagecontent .= "<br />".$search->searchInPages();
            } else {
                $pagecontent .= "<br />"."keine para";
            }
        }
            return false;
        }
return null;
# 1. suche im template mit eigener WEBSITE_TITLE oder DETAILMENU
# 2. es gibt eine cat suchen mit page suchen
# 3. es gibt einen link suchen


        # SEARCH ist im template und es wurde was gesucht
        if($value == "plugin_first" and getRequestValue('search')) {
#            define("CAT_REQUEST",NULL);
#            define("PAGE_REQUEST",NULL);
#            global $template;
#global $syntax;
#$title = $syntax->getWebsiteTitle("search");
#$template = str_replace("{DETAILMENU}","Dummy DETAILMENU",$template);
#$template = str_replace("{WEBSITE_TITLE}",$title,$template);
            global $pagecontent;
            $pagecontent = "{SEARCH|out}";
            return false;
        }

        global $CatPage;
        list($cat,$page) = $CatPage->split_CatPage_fromSyntax($value);

        require_once(BASE_DIR_CMS."SearchClass.php");
        $search = new SearchClass("SEARCH");

        if($value == "out" and getRequestValue('search')) {
            if($search->ifSearch()) {
                $search_result = $search->searchInPages();
            } else {
                $search_result = "keine para";
            }
            return "test".$search_result;
        }# $CatPage->get_Href($cat,$page)
        return $search->getUserSearchForm("search","Suchen.html",false,false,"default");

#if($value === false)
#return;
#echo "drin";
#echo str_replace("w","f","test");
$ttt = "test";
#if($ttt != ($ttr = str_replace("e","f","test")))
#echo "ja".$ttt;
        if(strstr($value,"searchlink=")) {
            list($cat,$page) = $CatPage->split_CatPage_fromSyntax(str_replace("searchlink=","",$value));
            return $CatPage->create_AutoLinkTag($cat,$page,"searchlink");
        }

        list($cat,$page) = $CatPage->split_CatPage_fromSyntax($value);

        require_once(BASE_DIR_CMS."SearchClass.php");
        $search = new SearchClass("SEARCH");

        $search->nosearchwords = "keine eingegeben";
        $search->searchnoresult = "nichts gefunden".trim(rawurldecode($SEARCH_REQUEST));

        $help = 'Für die Suche müssen sie Suchbegriffe in folgender Syntax eingeben. Durch Lehrzeichen getrente Begriffe ist eine oder Suche, Begriffen die ein Lehrzeichen enthalten mit " oder \' klammern.';
        if(!getRequestValue('helpsearch'))
            $help = '<a href="'.$CatPage->get_Href($cat,$page,$CatPage->get_Query("helpsearch=true")).'">Hilfe</a>';
#        $search_field = $search->getSearchForm($cat,$page,false);
#getUserSearchForm("search","false",$mpage = false,$action = false,$icon = false,$cat = false,$page = false)
        $search_field = $search->getUserSearchForm("search","true",false,false,"default",$cat,$page);
        $search_result = "";
        # getRequestValue('mactiv') ist hier nur damit wenn das default SEARCH noch drinn ist die suche geht
if($value == "out") {
        if($search->ifSearch()) {
            $search_result = $search->searchInPages();

        }
        return $search_field.$help.$search_result;
}


*/
?>